---
- name: 'Prepare for latest minor version'
  block:
    - name: 'Fetch version page'
      uri:
        url: 'https://sap.github.io/SapMachine/latest/{{ java_major_version }}/'
        return_content: true
        status_code: 200,404
      register: version_page

    - name: Find release version
      set_fact:
        release_version: >-
          {{ version_page.content | regex_search('(1.*[.|-]\d)') }}

    - name: Split release page
      set_fact:
        release_page: >-
          {{ sapmachine_root_page|string + 'tag/sapmachine-' + release_version|string }}
  when: java_minor_version == '*'

- name: 'Fetch artifact page'
  uri:
    url: '{{ release_page }}'
    status_code: 200,404
    return_content: true
  register: artifact_page

- name: Find artifact links
  set_fact:
    artifact_links: >-
      {{ artifact_page.content | regex_findall('(' + java_distribution|string + '-.*\/'
          + java_distribution|string + '-' + java_package|string + '-.*_linux-'
              + java_arch|string + '_bin.[sha256.txt|tar.gz]+)') }}

- name: Exit if SapMachine version is wrong
  fail:
    msg: >-
      {{ 'SapMachine version ' + java_major_version|string
              + (java_minor_version == '*') | ternary('', '.' + java_minor_version|string)
                + '_'+ java_arch|string + ' is wrong' }}
  when: artifact_links[0] is not defined

- name: 'Fetch artifact checksum file'
  uri:
    url: '{{ download_url }}{{ artifact_links[0] }}'
    return_content: true
  register: artifact_checksum_file

- name: Find artifact checksum
  set_fact:
    artifact_checksum: >-
      {{ artifact_checksum_file.content | regex_search('(^\w*)') }}

- name: 'Download artifact'
  get_url:
    url: '{{ download_url }}{{ artifact_links[1] }}'
    dest: '{{ java_download_path }}'
    checksum: 'sha256:{{ artifact_checksum }}'
  register: file_downloaded
  retries: 20
  delay: 5
  until: file_downloaded is succeeded
