---
- name: 'Fetch download page'
  win_uri:
    url: "{{ zulu_api_page }}\
      /bundles/latest/\
      ?version={{ java_major_version }}\
      &ext=zip&os=win&\
      arch={{ (java_arch == 'x64') | ternary('x64', 'x86') }}"
    return_content: true
    follow_redirects: all
  register: root_page

- name: Find release url and checksum
  set_fact:
    release_url: >-
      {{ [(root_page.content | from_json).url] + [(root_page.content | from_json).md5_hash] }}

- name: 'Get artifact checksum {{ release_url[1] }}'
  set_fact:
    artifact_checksum:
      content: >-
        {{ release_url[1] }}

- name: Exit if Zulu version is not found
  fail:
    msg: 'Zulu version {{ java_major_version }} not found'
  when: release_url is not defined

- name: 'Download artifact from {{ release_url[0] }}'
  win_get_url:
    url: '{{ release_url }}'
    dest: '{{ java_download_path }}'
    force: true
    checksum: '{{ artifact_checksum.content }}'
    checksum_algorithm: '{{ checksum_alg }}'
  register: file_downloaded
  retries: 20
  delay: 5
  until: file_downloaded is succeeded
  when: ansible_version.full is version('2.8.0', '>=')

- name: Old fetch (Ansible < 2.8)
  include_tasks: fetch_fallback_old.yml
  when: ansible_version.full is version('2.8.0', '<')
